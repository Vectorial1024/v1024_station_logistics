<?xml version="1.0" encoding="utf-8" ?>

<!-- Add in the code to encourage trades between logistically-linked stations -->
<diff>
    <add sel="/aiscript[@name='trade.find.commander']/attention/actions/label[@name='start']" pos="before">
        <!-- Ships are not supposed to change commanders in the middle of the script, so we can precalculate something for the ship. -->
        <set_value name="$mayWorkInLogNet" exact="this.ship.isplayerowned and $homebase.exists and (not $homebase.iswreck) and global.$stationLogisticsNetwork.{$homebase}?" />
        <do_if value="this.ship.isplayerowned" chance="0">
            <show_help position="1" duration="5s" custom="'' + global.$stationLogisticsNetwork" chance="0"/>
            <show_help position="1" duration="5s" custom="'Station logistics: trader participation:' + $mayWorkInLogNet" chance="0"/>
        </do_if>
    </add>

    <add sel="/aiscript[@name='trade.find.commander']/attention/actions/do_if[@value='$selloffers.count gt 0']/do_all/do_all/do_for_each/do_if[2]" pos="before">
        <!-- Add code to adjust station-export-wares -->
        <!-- This should be right after setting the tradevalue but before any checking can begin -->
        <do_if value="$mayWorkInLogNet and global.$stationLogisticsNetwork.{$homebase}.{$buyoffer_local.owner}?">
            <!-- Hit. -->
            <show_help position="1" duration="10s" custom="'Station logistics: trade encouraged.'" chance="0"/>
            <set_value name="$preferenceMulti" exact="1.25" />
            <do_if value="$homebase.istradestation and $buyoffer_local.owner.istradestation">
                <set_value name="$preferenceMulti" exact="1.125" comment="Avoid moving wares back-and-forth between trade stations if they can be pushed to other local stations" />
            </do_if>
            <set_value name="$loctradevalue" exact="$loctradevalue * $preferenceMulti" comment="Encourage selling to this target" />
        </do_if>
    </add>

    <add sel="/aiscript[@name='trade.find.commander']/attention/actions/do_if[@value='$buyoffers.count gt 0']/do_all/do_all/do_for_each/do_if[2]" pos="before">
        <!-- Add code to adjust station-import-wares -->
        <!-- This should be right after setting the tradevalue but before any checking can begin -->
        <do_if value="$mayWorkInLogNet and global.$sattionLogisticsNetwork.{$homebase}.{$selloffer_local.owner}?">
            <!-- Hit. -->
            <show_help position="1" duration="10s" custom="'Station logistics: trade encouraged.'" chance="0"/>
            <set_value name="$preferenceMulti" exact="1.25" />
            <do_if value="$homebase.istradestation and $buyoffer_local.owner.istradestation">
                <set_value name="$preferenceMulti" exact="1.125" comment="Avoid moving wares back-and-forth between trade stations if they can be pushed to other local stations" />
            </do_if>
            <set_value name="$loctradevalue" exact="$loctradevalue * $preferenceMulti" comment="Encourage buying from this target" />
        </do_if>
    </add>
</diff>
